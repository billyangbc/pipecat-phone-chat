# Silence Detection for Phone Chatbot

This feature enhances the Pipecat Phone Chatbot with silence detection capabilities, allowing the bot to:

1. Detect prolonged silence during a call
2. Play TTS prompts after a configurable period of silence
3. Gracefully terminate the call after a configurable number of unanswered prompts
4. Generate a post-call summary with statistics about the call

## How It Works

The silence detection system monitors the audio stream for periods of silence. When a user stops speaking, a timer starts. If the silence continues for longer than the configured threshold (default: 10 seconds), the bot will play a TTS prompt asking if the user is still there.

If the user responds, the conversation continues normally. If the user remains silent, the bot will play additional prompts. After a configurable number of unanswered prompts (default: 3), the bot will gracefully terminate the call.

At the end of the call, a summary is generated with statistics such as call duration, number of silence events, and whether the call was terminated due to silence.

## Configuration

The silence detection feature can be configured with the following parameters:

```json
{
  "config": {
    "silence_detection": {
      "testInPrebuilt": true,  // Set to true for testing in Daily Prebuilt, false for real calls
      "silenceThreshold": 10.0,  // Seconds of silence before triggering a prompt
      "maxUnansweredPrompts": 3  // Maximum number of unanswered prompts before terminating
    },
    "dialin_settings": {
      // Required for real calls, not needed for testing
    }
  }
}
```

## Testing Locally

You can test the silence detection feature locally using the provided test script:

```bash
./test_silence_detection.sh
```

This script will:
1. Start the bot runner
2. Configure the silence detection bot in test mode
3. Provide a Daily room URL where you can test the bot

When testing in Daily Prebuilt:
- The bot will introduce itself when you join
- If you remain silent for 10 seconds, the bot will ask if you're still there
- If you continue to remain silent, the bot will play additional prompts
- After 3 unanswered prompts, the bot will terminate the call
- A call summary will be displayed in the console

## Using with ngrok

To make your local bot accessible to external services, you can use ngrok:

```bash
ngrok http --domain yourdomain.ngrok.app 7860
```

Then, you can configure Daily to send webhooks to your ngrok URL:

```
https://yourdomain.ngrok.app/start
```

## Call Summary

At the end of each call, a summary is generated with the following information:

- Call duration
- Call start and end times
- Number of silence events
- Number of unanswered prompts
- Whether the call was terminated due to silence
- Details of each silence event (timestamp, duration, prompt number)

This summary is logged to the console and can be used for analytics or debugging purposes.

## Implementation Details

The silence detection feature is implemented in the `silence_detection.py` file. It uses a custom `SilenceDetector` class that extends the `FrameProcessor` class from the Pipecat framework.

The detector monitors the audio stream for `UserStartedSpeakingFrame` and `UserStoppedSpeakingFrame` events, which are generated by the VAD (Voice Activity Detection) system. When a user stops speaking, a timer starts. If the silence continues for longer than the configured threshold, the detector triggers a prompt.

The bot is configured to respond to special silence prompt messages with friendly reminders to the user. If the maximum number of unanswered prompts is reached, the bot terminates the call.
